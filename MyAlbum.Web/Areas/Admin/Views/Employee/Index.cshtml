@using MyAlbum.Models.Shared
@using System.Text.Json

@{
    ViewData["Title"] = "員工清單";
    var listUrl = Url.Action("GetEmployeeList", "Employee", new { area = "Admin" });
    var detailUrl = Url.Action("GetEmployee", "Employee", new { area = "Admin" });
}
@{
    var perm = new
    {
        canRead = User.HasClaim("perm", "Employee.Read"),
        canUpdate = User.HasClaim("perm", "Employee.Write"),
        canDelete = User.HasClaim("perm", "Employee.Delete")
    };
}
<script>window.PERM = @Html.Raw(JsonSerializer.Serialize(perm));</script>
<script src="~/js/simple-grid.js"></script>

<div class="container py-3">
    <h3 class="mb-3">@ViewData["Title"]</h3>

    <!-- 可選的查詢表單（name 對應 EmployeeListReq 的屬性） -->
    <form id="empSearch" class="row g-2 mb-3">
        @Html.AntiForgeryToken()
        <div class="col-auto">
            <input type="text" class="form-control" name="FullName" placeholder="姓名（模糊查）">
        </div>

        <div class="col-auto">
            <button class="btn btn-primary" type="submit">查詢</button>
        </div>
    </form>

    @await Html.PartialAsync("_Grid", new GridOptions
    {
        ListUrl = listUrl,
        SearchFormId = "empSearch",
        TableId = "empTable",
        PagerId = "empPager",
        TotalId = "empTotal",
        PageSize = 10,
        Columns = new List<GridColumn> {
            new("fullName",   "姓名"),
            new("title",      "職稱"),
            new("hireDate",   "雇用日期", null, "date"),
            new("isActive",   "啟用", "90px", "bool"),
            new("employeeId", "操作", null, "actions")
        }
    })
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">員工明細</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <dl class="row" id="detailsBody">
                    <!-- 動態填入 -->
                </dl>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">關閉</button></div>
        </div>
    </div>
</div>

<script>

    function escapeHtml(str) {
        if (str === null || str === undefined) return "";
        return str.toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    window.cellFormatters = Object.assign({}, window.cellFormatters, {
      actions: (id, row) => {
        const b=[];
        if (window.PERM?.canRead)   b.push(`<button class="btn btn-sm btn-outline-secondary me-1" onclick="openDetails(${id})">檢視</button>`);
        if (window.PERM?.canUpdate) b.push(`<button class="btn btn-sm btn-primary me-1" onclick="editEmp(${id})">更新</button>`);
        if (window.PERM?.canDelete) b.push(`<button class="btn btn-sm btn-danger" onclick="delEmp(${id})">刪除</button>`);
        return b.join("");
      }
    });
    window.openDetails = async function(id){
        const detailUrl = '@detailUrl';
        const url = `${detailUrl}?id=${id}`;
        const res = await fetch(url);
        if (!res.ok){ alert("查無資料"); return; }
        const d = await res.json();
        const dl = document.getElementById('detailsBody');

        const hireDate = d.hireDate ? d.hireDate.substring(0,10) : "未設定";

        dl.innerHTML = `
            <dt class="col-4">姓名</dt><dd class="col-8">${escapeHtml(d.fullName)}</dd>
            <dt class="col-4">職稱</dt><dd class="col-8">${escapeHtml(d.title ?? "")}</dd>
            <dt class="col-4">到職日</dt><dd class="col-8">${hireDate}</dd>
            <dt class="col-4">啟用</dt><dd class="col-8">${d.isActive ? "✅" : "❌"}</dd>
        `;
        detailsModal.show();
    };
    window.editEmp = async function(id){
        console.log('editEmp', id)
    };
    window.delEmp  = async function(id){
      if(!confirm(`確定刪除 #${id}？`)) return;
      const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value ?? "";
      const res = await fetch('@Url.Action("Delete", "Employee", new { area = "Admin" })', {
        method: 'POST',
        headers: { 'Content-Type':'application/json','RequestVerificationToken': token },
        body: JSON.stringify({ id })
      });
      if (res.ok) {
          document.querySelector('#empSearch')?.dispatchEvent(new Event('submit')); 
      }
      else alert('刪除失敗');
    };
</script>
@section Scripts {
    <script>
        const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
    </script>
}